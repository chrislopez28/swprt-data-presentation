---
title: "R for Water Quality: <br>Region 4 Experiences"
author: "Chris Lopez <br>Los Angeles Water Board"
date: "December 11, 2018"
output: ioslides_presentation
autosize: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

<style>
div.footnotes {
  position: absolute;
  bottom: 0;
  margin-bottom: 10px;
  width: 80%;
  font-size: 0.6em;
}
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<script>
  $(document).ready(function() {
    $('slide:not(.backdrop):not(.title-slide)').append('<div class=\"footnotes\">');

    $('footnote').each(function(index) {
      var text  = $(this).html();
      var fnNum = (index+1).toString().sup();
      $(this).html(text + fnNum);

      var footnote   = fnNum + ': ' + $(this).attr('content') + '<br/>';
      var oldContent = $(this).parents('slide').children('div.footnotes').html();
      var newContent = oldContent + footnote;
      $(this).parents('slide').children('div.footnotes').html(newContent);
    });
  });
</script>

<style>
.small-code pre code {
  font-size: 1em;
}
</style>



## Presentation Objectives

* Examples of R
* Strengths and Weaknesses of R

## My Background

* Staff in Municipal Stormwater Permitting Unit (i.e. the MS4 Unit)
* Some rudimentary background in programming/coding
* Enjoy learning new things
* Appreciate good communication of information

## Disclaimer

* I am not an expert
* Tools, packages, and best practices evolve

## R

- __Programming__ Language and Environment for Statistical Computing and Graphics
- __Open-source__
- Large ecosystem of freely available __packages__

## Example 1: Plotting IGP Sites on Map

1. Use **SMARTS** Storm Water Data File Download menu, download a tab-delimited file text file of "Storm Water Applications - General Information" for Region 4. 
2. Load the file into R and filter for **active IGP** sites.
3. Use Leaflet package to plot sites on map and display specific information on mouseover.

## Example 1: Plotting IGP Sites on Map

```{r igp_code, echo=TRUE, message=FALSE, eval=FALSE}

library(dplyr)
library(leaflet)
library(htmltools)

# Load File
filename <- "data/smarts_swapps_geninfo_2018-12-09.txt"
rb4 <- read.delim(filename, sep = "\t", stringsAsFactors = FALSE)

# Filter IGP Sites
rb4igp <- rb4 %>% 
  filter(PERMIT_TYPE == "Industrial") %>%
  filter(STATUS == "Active")

# Plot Map Using Leaflet (code for labels omitted due to space)
leaflet(rb4igp) %>% addTiles() %>%
  addCircles(lng = ~FACILITY_SITE_LONGITUDE, lat = ~FACILITY_SITE_LATITUDE,
             opacity = 0.75, label = lapply(labs, HTML))
  
```

## Example 1: Plotting IGP Sites on Map

```{r igp_output, echo = FALSE, message=FALSE}
library(dplyr)
library(leaflet)
library(htmltools)

filename <- "data/smarts_swapps_geninfo_2018-12-09.txt"

rb4 <- read.delim(filename, sep = "\t", stringsAsFactors = FALSE)

rb4igp <- rb4 %>%
  filter(PERMIT_TYPE == "Industrial") %>%
  filter(STATUS == "Active")

labs <- lapply(seq(nrow(rb4igp)), function(i) {
  paste0( '<b>', rb4igp[i, "OWNER_OPERATOR_NAME"], '</b></br>', 
          rb4igp[i, "FACILITY_SITE_NAME"], '</br>', 
          rb4igp[i, "FACILITY_SITE_ADDRESS"], '</br>', 
          rb4igp[i, "FACILITY_SITE_CITY"], ', ', 
          rb4igp[i, "FACILITY_SITE_STATE"], ' ', 
          rb4igp[i, "FACILITY_SITE_ZIP"]) 
})

leaflet(rb4igp) %>% 
  addTiles() %>%
  addCircles(lng = ~FACILITY_SITE_LONGITUDE, lat = ~FACILITY_SITE_LATITUDE,
             opacity = 0.75, label = lapply(labs, HTML))
  
```

## Example 2: Scraping Tables from PDFs

- **File**: PDF Report on Trash Assessments in San Mateo County, CA
- **Objective**: Want to get data from tables within the document for data analysis, graphs, Excel, etc.

## Example 2: Scraping Tables from PDFs

<img src="images/trashtable1.png" align="middle" height="500" width="500" margin="0 auto" />

## Example 2: Scraping Tables from PDFs

<img src="images/trashtable2.png" align="middle" height="450" width="750" margin="0 auto" />

## Example 2: Scraping Tables from PDFs

```{r scrape_code, echo=TRUE, message=FALSE, eval=FALSE}
library(tabulizer)

report <- "pdf/San Mateo trash RTAs 2006-07.pdf"
lst <- extract_tables(report, encoding="UTF-8")

```

## Example 2: Scraping Tables from PDFs

<img src="images/trashtable1out.png" align="middle" height="450" width="750" margin="0 auto" />

## Example 2: Scraping Tables from PDFs

<img src="images/trashtable2out.png" align="middle" height="450" width="750" margin="0 auto" />

## Example 3: Analyzing Large Datasets for Compliance - Bacteria

- Renewal of Region 4 Phase I MS4 Permits
    + Need to evaluate monitoring data (~40 TMDLs in permit)
- Bacteria
    + **Sites**: ~ 100 receiving water monitoring sites
    + **Water Type**: Marine or Fresh
    + **Beneficial Use**: REC-1, LREC-1, REC-2
    + **Frequency**: Weekly (or more frequent) 
    + **Period**: 10 Years
    + **Parameters**: 4 Indicator Bacteria
    + **Limitations**: Daily and Geo Mean 

## Example 3: Analyzing Large Datasets for Compliance - Bacteria
- Data Estimate:
    + $(52 \ weeks)(10 \ years)(4 \ parameters)(100 \ sites)$
    + $\approx \ 200,000 \ data \ points$
    + $\approx \ 200,000 \ geometric \ means$
    + $\approx \ 400,000 \ comparisons$

## Example 3: Analyzing Large Datasets for Compliance - Bacteria
- Created a Microsoft VBA Tool:

<img src="images/bact_checker.png" align="middle" height="400" width="600" margin="0 auto" />


## Example 3: Analyzing Large Datasets for Compliance - Bacteria
- Created a Microsoft VBA Tool:

<img src="images/bact_checker.png" align="middle" height="400" width="600" margin="0 auto" />

## Example 4: Mapping Monitoring Data

- 


## Example 5: Network Graphs


## Example 6: RAA Output Files

- RAA output given as text file output

## Example 6: RAA Output Files - Plotting



## Example 7: Facets

- Plot subsets of data in side-by-side plots
- Wet Weather vs. Dry Weather
- Monitoring Stations
- Parameter by Parameter

## Example 7: Facets - Geofaceting

## Example 8: Statistics

## Example 8: Statistics - Regression Matrix

## Example 9: Statistical Modeling

## Example 10: Presentations

This is an R Markdown presentation. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

## RStudio

- Free and Open-Source "Integrated Development Environment (IDE)" for R
- _Highly, highly recommended if you want to use <footnote content="Chris is not affiliated with RStudio nor receives any incentives for recommending RStudio">R!!!_

<img src="images/RStudio.png" align="middle" height="200" width="400") />


## What does R look like?

<img src="images/rstudioscreen.png" align="middle" height="450" width="750" margin="0 auto" />

## What does R look like?

<img src="images/rstudioscreen_captions.png" align="middle" height="450" width="750" margin="0 auto" />

## Strengths (Much applies to other programming languages as well)
- Repeatable
- Transparent
- Automation
- Packages 

## Weaknesses
- Learning Curve
- Sometimes I have nothing to show for
- Sometimes I lose sight of big picture

## Final Thoughts
- R and R Packages are just another set of tools
- Improve our ability to communicate
- Improve our ability to
- 

## End

Chris Lopez </br>
Los Angeles Water Board </br>
Stormwater Permitting Unit </br>
chris.lopez@waterboards.ca.gov
https://github.com/chrislopez28
